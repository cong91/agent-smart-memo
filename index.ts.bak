/**
 * Qdrant Memory Plugin for OpenClaw
 * Simple & Stable Version
 */

import { loadConfig } from "./src/config";
import { QdrantClient } from "./src/services/qdrant";
import { EmbeddingClient } from "./src/services/embedding";
import { DeduplicationService } from "./src/services/dedupe";
import { createMemoryStoreTool } from "./src/tools/memory_store";
import { createMemorySearchTool } from "./src/tools/memory_search";

export default {
  id: "memory-qdrant",
  name: "Qdrant Memory Plugin",
  version: "1.0.0",

  register(api: any) {
    try {
      const config = loadConfig(api);
      const qdrant = new QdrantClient(config, api.logger);
      const embedding = new EmbeddingClient(config, api.logger);
      const dedupe = new DeduplicationService(config.similarityThreshold, api.logger);

      // Register tools
      const storeTool = createMemoryStoreTool(qdrant, embedding, dedupe, config.defaultNamespace);
      const searchTool = createMemorySearchTool(qdrant, embedding, config.defaultNamespace);

      api.registerTool(storeTool, { optional: false });
      api.registerTool(searchTool, { optional: false });

      api.logger.info("✅ [Memory-Qdrant] Plugin loaded successfully");
      api.logger.info(`   Collection: ${config.collectionName}`);
      api.logger.info(`   Vector Size: ${config.vectorSize}`);

      // Init collection async
      qdrant.createCollection().catch((err: any) => {
        api.logger.error(`[Memory-Qdrant] Failed to create collection: ${err.message}`);
      });

    } catch (error: any) {
      api.logger.error(`❌ [Memory-Qdrant] Failed to load: ${error.message}`);
      throw error;
    }
  },
};
